name: Smart Auto Deploy to STB

on:
  push:
    branches:
      - main
      - development

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Detect full or diff deploy
        run: |
          # === VARIABEL DASAR ===
          REPO_NAME=${{ github.event.repository.name }}
          AUTOHOST_URL="https://autohost.akhzafachrozy.my.id"

          echo "ðŸš€ Checking hosting status for $REPO_NAME ..."
          STATUS_CODE=$(curl -o /dev/null -s -w "%{http_code}" "$AUTOHOST_URL/status?repo=$REPO_NAME")

          if [ "$STATUS_CODE" = "404" ]; then
            echo "ðŸ†• Repo belum pernah di-hosting, kirim full project..."
            zip -r deploy.zip . -x ".git/*" ".github/*"
          else
            echo "ðŸ”„ Repo sudah pernah di-hosting, kirim file yang berubah saja..."
            git fetch origin main || true
            git diff --name-only HEAD^ HEAD > changed_files.txt
            mkdir deploy_package

            while read file; do
              if [ -f "$file" ]; then
                mkdir -p "deploy_package/$(dirname "$file")"
                cp "$file" "deploy_package/$file"
              fi
            done < changed_files.txt

            cd deploy_package
            zip -r ../deploy.zip .
            cd ..
          fi

      - name: Upload to AutoHost
        run: |
          REPO_NAME=${{ github.event.repository.name }}
          curl -X POST -F "repo=$REPO_NAME" -F "file=@deploy.zip" https://autohost.akhzafachrozy.my.id
