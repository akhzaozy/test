name: Auto Deploy to STB (Fast Mode)

on:
  push:
    branches:
      - main
      - development

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Build Deploy Package
        run: |
          echo "ðŸ“¦ Membuat paket deploy..."
          git diff --name-only HEAD^ HEAD > changed_files.txt || true
          git diff --name-status HEAD^ HEAD | grep '^D' | cut -f2 > deleted_files.txt || true

          mkdir deploy_package
          while read file; do
            if [ -f "$file" ]; then
              mkdir -p "deploy_package/$(dirname "$file")"
              cp "$file" "deploy_package/$file"
            fi
          done < changed_files.txt

          cp deleted_files.txt deploy_package/ || true
          cd deploy_package
          zip -r -q ../deploy.zip .
          cd ..

      - name: ðŸš€ Upload to AutoHost
        run: |
          REPO_NAME=${{ github.event.repository.name }}
          echo "ðŸš€ Uploading to AutoHost ($REPO_NAME)..."
          time curl -s -S -k -m 60 --connect-timeout 10 \
            -w "\nâœ… Done in %{time_total}s, status %{http_code}\n" \
            -o response.log \
            -X POST -F "repo=$REPO_NAME" -F "file=@deploy.zip" \
            https://autohost.akhzafachrozy.my.id
          cat response.log
