name: ðŸš€ Auto Deploy to Kucingarong

on:
  push:
    branches:
      - main
      - development
      - feature/**

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repo
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Zip seluruh repo (kecuali vendor dan node_modules)
      - name: ðŸ“¦ Create deploy package
        run: |
          echo "Zipping repository..."
          zip -r deploy.zip . \
            -x "*.git*" \
               "vendor/*" \
               "node_modules/*" \
               "*.github/*" \
               "*.DS_Store"
          echo "âœ… ZIP package created"

      # 3ï¸âƒ£ Upload ke server AutoHost (Kucingarong)
      - name: ðŸš€ Upload to Kucingarong AutoHost
        env:
          REPO_NAME: ${{ github.event.repository.name }}
          AUTOHOST_URL: "https://cicak.akhzafachrozy.my.id"   # ubah ke domain kamu
        run: |
          echo "ðŸš€ Deploying $REPO_NAME to $AUTOHOST_URL..."
          RESPONSE=$(curl -s -S -k -m 180 --connect-timeout 15 \
            -X POST \
            -F "repo=$REPO_NAME" \
            -F "file=@deploy.zip" \
            "$AUTOHOST_URL")

          echo "ðŸ“œ ===== RESPONSE FROM SERVER ====="
          echo "$RESPONSE"
          echo "ðŸ“œ ================================="

      # 4ï¸âƒ£ Simpan log output ke artifact (opsional tapi berguna) woww
      - name: ðŸ—‚ï¸ Save deploy log
        if: always()
        run: echo "$RESPONSE" > deploy_output.log

      - name: ðŸ“¤ Upload log as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log
          path: deploy_output.log
