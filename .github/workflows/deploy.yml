name: Auto Deploy to STB (Async Single File)

on:
  push:
    branches:
      - main
      - development

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Build deploy package
        run: |
          echo "ðŸ“¦ Membuat paket deploy..."
          git diff --name-only HEAD^ HEAD > changed_files.txt || true
          mkdir deploy_package
          while read file; do
            if [ -f "$file" ]; then
              mkdir -p "deploy_package/$(dirname "$file")"
              cp "$file" "deploy_package/$file"
            fi
          done < changed_files.txt
          cd deploy_package
          zip -r -q ../deploy.zip .
          cd ..

      - name: ðŸš€ Upload to AutoHost (Async)
        run: |
          REPO_NAME=${{ github.event.repository.name }}
          echo "ðŸš€ Uploading to AutoHost ($REPO_NAME)..."
          curl -s -S -k -m 10 --connect-timeout 5 \
            -X POST -F "repo=$REPO_NAME" -F "file=@deploy.zip" \
            https://autohost.akhzafachrozy.my.id
          echo "âœ… Upload selesai, deploy berjalan di background di STB."
