name: Auto Deploy to STB Host

on:
  push:
    branches:
      - main
      - development

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Prepare Deploy Package
        run: |
          echo "ðŸ“¦ Membuat paket deploy..."
          git fetch origin || true
          git diff --name-only HEAD^ HEAD > changed_files.txt || true
          git diff --name-status HEAD^ HEAD | grep '^D' | cut -f2 > deleted_files.txt || true

          mkdir deploy_package
          while read file; do
            if [ -f "$file" ]; then
              mkdir -p "deploy_package/$(dirname "$file")"
              cp "$file" "deploy_package/$file"
            fi
          done < changed_files.txt

          cp deleted_files.txt deploy_package/ || true

          cd deploy_package
          zip -r -q ../deploy.zip .
          cd ..
          echo "âœ… deploy.zip dibuat."

      - name: ðŸš€ Upload & Deploy to AutoHost
        run: |
          REPO_NAME=${{ github.event.repository.name }}
          AUTOHOST_URL="https://autohost.akhzafachrozy.my.id"

          echo "ðŸš€ Mengirim paket deploy ke AutoHost ($REPO_NAME)..."
          RESPONSE=$(curl -s -S -k -m 120 --connect-timeout 15 \
            -X POST \
            -F "repo=$REPO_NAME" \
            -F "file=@deploy.zip" \
            "$AUTOHOST_URL")

          echo "ðŸ“œ ===== RESPONSE DARI SERVER ====="
          echo "$RESPONSE"
          echo "ðŸ“œ ================================="

      - name: ðŸ§  Simpan Info Login ke Artifact
        if: always()
        run: |
          echo "Menyimpan hasil respon ke file..."
          echo "$RESPONSE" > deploy-info.txt
          echo "âœ… Selesai, file tersimpan."

      - name: ðŸ“¤ Upload Deployment Info Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-info
          path: deploy-info.txt
